<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pwned! - Controle de Integridade</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulseRed { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 50% { box-shadow: 0 0 15px 5px rgba(239, 68, 68, 0.3); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes progress { from { width: 0%; } to { width: 100%; } }

        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        .animate-zoom-in { animation: zoomIn 0.2s ease-out forwards; }
        .animate-slide-in { animation: slideInRight 0.3s ease-out forwards; }
        .animate-pulse-red { animation: pulseRed 2s infinite; }
        .animate-shake { animation: shake 0.3s ease-in-out; }
        .animate-progress { animation: progress 7s linear forwards; }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 950: '#020617' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-950 text-white min-h-screen">

    <div id="app" class="min-h-screen flex flex-col"></div>

    <script>
        // --- CONFIGURAÇÃO ---
        const ALL_COLORS = [
            { name: 'Vermelho', hex: '#ef4444' },
            { name: 'Azul', hex: '#3b82f6' },
            { name: 'Verde', hex: '#22c55e' },
            { name: 'Amarelo', hex: '#eab308' },
            { name: 'Roxo', hex: '#a855f7' },
            { name: 'Rosa', hex: '#ec4899' },
            { name: 'Laranja', hex: '#f97316' },
            { name: 'Ciano', hex: '#06b6d4' },
            { name: 'Cinza', hex: '#64748b' },
            { name: 'Índigo', hex: '#6366f1' },
        ];
        const VALUES_OPTIONS = [5, 10, 15, 20, 25];

        // --- ESTADO ---
        const state = {
            view: 'SETUP',
            players: [],
            newPlayerName: '',
            selectedColor: null,
            startTime: null,
            endTime: null,
            gameDuration: 0,
            activeRulesTab: 'overview',
            attackMode: false,
            modals: {
                rules: false,
                confirmEnd: false,
                longPress: { visible: false, playerId: null, type: null, x: 0, y: 0 },
                attack: { visible: false, targetId: null, baseDamage: 10, hasDefense: false },
                attackResult: { visible: false, message: '', type: '', base: 0, actual: 0 } // Novo estado para o resultado
            }
        };

        let gameTimerInterval = null;
        let longPressTimer = null;
        let resultAutoCloseTimer = null;
        let isLongPress = false;

        // --- LÓGICA DO JOGO ---

        function init() {
            autoSelectColor();
            render();
        }

        function autoSelectColor() {
            const usedColors = state.players.map(p => p.color.name);
            const available = ALL_COLORS.filter(c => !usedColors.includes(c.name));
            
            if (!state.selectedColor || usedColors.includes(state.selectedColor.name)) {
                if (available.length > 0) state.selectedColor = available[0];
            }
        }

        function getAvailableColors() {
            return ALL_COLORS.filter(c => 
                !state.players.some(p => p.color.name === c.name) || (state.selectedColor && c.name === state.selectedColor.name)
            );
        }

        function addPlayer(e) {
            e.preventDefault();
            let finalName = state.newPlayerName.trim();
            if (!finalName) {
                finalName = `Player ${state.players.length + 1}`;
            }

            if (!state.selectedColor) autoSelectColor();

            const newPlayer = {
                id: Date.now(),
                name: finalName,
                color: state.selectedColor,
                score: 100,
                status: 'ACTIVE',
                survivalTime: null
            };

            state.players.push(newPlayer);
            state.newPlayerName = '';
            state.selectedColor = null; 
            autoSelectColor();
            render();
        }

        function removePlayer(id) {
            state.players = state.players.filter(p => p.id !== id);
            autoSelectColor();
            render();
        }

        function startGame() {
            if (state.players.length === 0) return;
            state.startTime = Date.now();
            state.view = 'PLAYING';
            
            if (gameTimerInterval) clearInterval(gameTimerInterval);
            gameTimerInterval = setInterval(() => {
                const timerEl = document.getElementById('game-timer-display');
                if (timerEl) {
                    timerEl.innerText = formatTime(Date.now() - state.startTime);
                }
            }, 1000);
            render();
        }

        function finishGame() {
            clearInterval(gameTimerInterval);
            state.endTime = Date.now();
            state.gameDuration = state.endTime - state.startTime;
            state.players = state.players.map(p => {
                if (p.status === 'ACTIVE') return { ...p, status: 'WINNER', survivalTime: state.gameDuration };
                return p;
            });
            state.attackMode = false;
            state.view = 'FINISHED';
            state.modals.confirmEnd = false;
            // Se houver modal de resultado aberto, fecha ele
            closeResultModal();
            render();
        }

        function checkGameOver() {
            const activePlayers = state.players.filter(p => p.status === 'ACTIVE');
            if ((activePlayers.length <= 1 && state.players.length > 1) || (state.players.length === 1 && activePlayers.length === 0)) {
                finishGame();
                return true;
            }
            return false;
        }

        function updateScore(playerId, delta) {
            const currentWaitTime = Date.now() - state.startTime;
            state.players = state.players.map(player => {
                if (player.id !== playerId || player.status !== 'ACTIVE') return player;
                let newScore = player.score + delta;
                let newStatus = player.status;
                let survivalTime = player.survivalTime;
                
                if (newScore <= 0) {
                    newScore = 0;
                    newStatus = 'ELIMINATED';
                    survivalTime = currentWaitTime;
                }
                return { ...player, score: newScore, status: newStatus, survivalTime };
            });
            
            const isOver = checkGameOver();
            if (isOver) {
                state.attackMode = false;
            }
            render();
        }

        function resetGame() {
            state.players = [];
            state.view = 'SETUP';
            state.startTime = null;
            state.endTime = null;
            state.activeRulesTab = 'overview';
            state.selectedColor = null;
            state.attackMode = false;
            closeResultModal();
            autoSelectColor();
            render();
        }

        // --- LÓGICA DE ATAQUE ---
        
        function toggleAttackMode() {
            state.attackMode = !state.attackMode;
            render();
        }

        function openAttackModal(targetId) {
            state.modals.attack = {
                visible: true,
                targetId: targetId,
                baseDamage: 10,
                hasDefense: false
            };
            render();
        }

        function executeAttack() {
            const { targetId, baseDamage, hasDefense } = state.modals.attack;
            const dmgInt = parseInt(baseDamage) || 0;
            const result = calculateAttackDamage(dmgInt, hasDefense);

            // Aplica o dano (negativo)
            updateScore(targetId, -result.damage);
            
            // Fecha modal de input
            state.modals.attack.visible = false;

            // Abre modal de resultado
            state.modals.attackResult = {
                visible: true,
                message: result.message,
                type: result.type,
                base: dmgInt,
                actual: result.damage
            };

            // Timer de 7 segundos para fechar
            if (resultAutoCloseTimer) clearTimeout(resultAutoCloseTimer);
            resultAutoCloseTimer = setTimeout(() => {
                closeResultModal();
            }, 7000);

            render();
        }

        function closeResultModal() {
            state.modals.attackResult.visible = false;
            if (resultAutoCloseTimer) clearTimeout(resultAutoCloseTimer);
            render();
        }

        function calculateAttackDamage(baseDmg, hasDefense) {
            const roll = Math.random() * 100;
            
            if (!hasDefense) {
                // SEM DEFESA
                if (roll < 10) {
                    return { damage: 0, message: "Erro de Sintaxe: O malware falhou na execução!", type: 'info' };
                } else {
                    // Dano base com chance de leve aumento
                    const multiplier = 1 + (Math.random() * 0.2); 
                    const finalDmg = Math.ceil(baseDmg * multiplier);
                    return { damage: finalDmg, message: "Ataque bem sucedido! Sistema comprometido.", type: 'danger' };
                }
            } else {
                // COM DEFESA
                if (roll < 50) {
                    // 0 a 49.99
                    return { damage: 0, message: "Analista percebeu o ataque em tempo!", type: 'success' };
                } else if (roll < 80) {
                    // 50 a 79.99
                    const dmg = Math.ceil(baseDmg * 0.10);
                    return { damage: dmg, message: "Dano superficial. Defesa absorveu o impacto.", type: 'warning' };
                } else if (roll < 95) {
                    // 80 a 94.99
                    const dmg = Math.ceil(baseDmg * 0.35);
                    return { damage: dmg, message: "Brecha parcial encontrada na defesa.", type: 'warning' };
                } else {
                    // 95 a 100
                    const dmg = Math.ceil(baseDmg * 0.75);
                    return { damage: dmg, message: "As defesas não estavam bem implementadas! :(", type: 'danger' };
                }
            }
        }

        // --- HANDLERS ---
        function handleButtonDown(e, playerId, type) {
            if(state.attackMode) return;
            if(e.type === 'touchstart') e.stopPropagation();
            isLongPress = false;
            const rect = e.currentTarget.getBoundingClientRect();
            
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                state.modals.longPress = { 
                    visible: true, playerId, type, 
                    x: rect.left + rect.width / 2, 
                    y: rect.top 
                };
                render();
            }, 500);
        }

        function handleButtonUp(playerId, type) {
            if(state.attackMode) return;
            if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
            if (!isLongPress && !state.modals.longPress.visible) {
                updateScore(playerId, type === 'add' ? 1 : -1);
            }
        }

        function handlePlayerClick(playerId) {
            if (!state.attackMode) return;
            const player = state.players.find(p => p.id === playerId);
            if (player.status === 'ELIMINATED') return;
            openAttackModal(playerId);
        }

        function handleMenuSelect(value) {
            const { playerId, type } = state.modals.longPress;
            if (playerId && type) updateScore(playerId, type === 'add' ? value : -value);
            state.modals.longPress = { visible: false, playerId: null, type: null, x: 0, y: 0 };
            isLongPress = false;
            render();
        }

        function formatTime(ms) {
            if (!ms) return "00:00";
            const totalSeconds = Math.floor(ms / 1000);
            return `${Math.floor(totalSeconds / 60).toString().padStart(2, '0')}:${(totalSeconds % 60).toString().padStart(2, '0')}`;
        }

        function getLeaderId() {
            if (state.players.length === 0) return null;
            const active = state.players.filter(p => p.status === 'ACTIVE');
            if (active.length === 0) return null;
            return active.reduce((prev, curr) => (prev.score > curr.score) ? prev : curr).id;
        }

        // --- RENDERIZAÇÃO ---
        function render() {
            const app = document.getElementById('app');
            let html = '';

            if (state.view === 'SETUP') html = renderSetup();
            else if (state.view === 'PLAYING') html = renderPlaying();
            else if (state.view === 'FINISHED') html = renderFinished();

            if (state.modals.rules) html += renderRulesModal();
            if (state.modals.confirmEnd) html += renderConfirmModal();
            if (state.modals.longPress.visible) html += renderLongPressMenu();
            if (state.modals.attack.visible) html += renderAttackModal();
            if (state.modals.attackResult.visible) html += renderResultModal();

            app.innerHTML = html;
            lucide.createIcons();

            // Foco inputs
            if (state.view === 'SETUP' && document.getElementById('input-name') && state.newPlayerName) {
                const input = document.getElementById('input-name');
                input.focus();
                const len = input.value.length;
                input.setSelectionRange(len, len);
            }
            if (state.modals.attack.visible && document.getElementById('attack-input')) {
                document.getElementById('attack-input').focus();
            }
        }

        // 1. SETUP SCREEN
        function renderSetup() {
            const availableColors = getAvailableColors();
            return `
            <div class="min-h-screen p-6 flex flex-col items-center justify-center font-sans relative animate-fade-in">
                <div class="absolute top-4 right-4">
                    <button onclick="state.modals.rules = true; render()" class="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-full text-sm font-semibold text-green-400 border border-green-500/30 transition-all">
                        <i data-lucide="book-open" class="w-4 h-4"></i> Regras
                    </button>
                </div>

                <div class="max-w-md w-full bg-slate-900 p-8 rounded-2xl shadow-2xl border border-slate-800">
                    <div class="flex flex-col items-center justify-center mb-8 gap-2">
                        <div class="bg-green-600/20 p-4 rounded-full border border-green-500/30 shadow-[0_0_15px_rgba(34,197,94,0.3)]">
                            <i data-lucide="shield" class="w-10 h-10 text-green-500"></i>
                        </div>
                        <h1 class="text-4xl font-black tracking-tighter text-white">Pwned<span class="text-green-500">!</span></h1>
                        <p class="text-slate-500 text-sm">Controle de Integridade</p>
                    </div>

                    <form onsubmit="addPlayer(event)" class="space-y-4 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">Nome</label>
                            <input id="input-name" type="text" value="${state.newPlayerName}" oninput="state.newPlayerName = this.value" placeholder="Ex: Player ${state.players.length + 1}"
                                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all text-white placeholder-slate-600 font-mono" maxlength="15" />
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Cor</label>
                            <div class="flex flex-wrap gap-2">
                                ${availableColors.map(color => `
                                    <button type="button" onclick='state.selectedColor = ${JSON.stringify(color)}; render()'
                                        class="w-8 h-8 rounded-md border-2 transition-all duration-200 ${state.selectedColor && state.selectedColor.name === color.name ? 'border-white scale-110 shadow-[0_0_10px_rgba(255,255,255,0.3)] opacity-100' : 'border-transparent opacity-40 hover:opacity-100'}"
                                        style="background-color: ${color.hex};"></button>
                                `).join('')}
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2 shadow-lg shadow-green-900/20 active:scale-95">
                            <i data-lucide="plus" class="w-5 h-5"></i> Inserir Jogador
                        </button>
                    </form>

                    ${state.players.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="text-xs font-bold text-slate-500 mb-3 uppercase tracking-wider flex justify-between items-center">
                                Jogadores <span class="bg-slate-800 px-2 py-0.5 rounded text-slate-300">${state.players.length}</span>
                            </h3>
                            <div class="space-y-2 max-h-52 overflow-y-auto pr-1 custom-scrollbar">
                                ${state.players.map(p => `
                                    <div class="flex items-center justify-between bg-slate-800/50 p-3 rounded-lg border border-slate-700/50 hover:border-slate-600 transition-colors group">
                                        <div class="flex items-center gap-3">
                                            <div class="w-3 h-3 rounded-full" style="background-color: ${p.color.hex}; box-shadow: 0 0 8px ${p.color.hex}"></div>
                                            <span class="font-mono font-bold text-sm">${p.name}</span>
                                        </div>
                                        <button onclick="removePlayer(${p.id})" class="text-slate-600 group-hover:text-red-400 transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <button onclick="startGame()" ${state.players.length === 0 ? 'disabled' : ''} class="w-full bg-slate-100 hover:bg-white text-slate-900 disabled:opacity-50 disabled:cursor-not-allowed font-black py-4 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2 text-lg tracking-tight">
                        <i data-lucide="play" class="w-6 h-6 fill-slate-900 text-slate-900"></i> INICIAR PROTOCOLO
                    </button>
                </div>
            </div>`;
        }

        // 2. PLAYING SCREEN
        function renderPlaying() {
            const leaderId = getLeaderId();
            return `
            <div class="min-h-screen p-3 flex flex-col relative overflow-hidden transition-colors duration-500 ${state.attackMode ? 'bg-red-950/30' : ''}" onmouseup="if(longPressTimer) clearTimeout(longPressTimer)" ontouchend="if(longPressTimer) clearTimeout(longPressTimer)">
                
                <!-- HEADER -->
                <div class="flex justify-between items-center mb-4 bg-slate-900/90 backdrop-blur px-4 py-3 rounded-xl border border-slate-800 shadow-md sticky top-2 z-30">
                    <div class="flex items-center gap-3">
                        <h1 class="font-black text-xl tracking-tighter hidden sm:block">Pwned<span class="text-green-500">!</span></h1>
                        <div class="flex items-center gap-2 text-slate-400 text-xs sm:text-sm font-mono">
                            <i data-lucide="clock" class="w-4 h-4 animate-pulse text-green-500"></i>
                            <span><span id="game-timer-display" class="text-slate-200">${formatTime(Date.now() - state.startTime)}</span></span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleAttackMode()" class="p-2 rounded-lg transition-all border ${state.attackMode ? 'bg-red-600 text-white border-red-400 animate-pulse shadow-[0_0_10px_rgba(220,38,38,0.5)]' : 'bg-slate-800 text-slate-400 border-transparent hover:bg-slate-700'}">
                            <i data-lucide="${state.attackMode ? 'skull' : 'bug'}" class="w-5 h-5"></i>
                        </button>
                        
                        <div class="w-px h-8 bg-slate-700 mx-1"></div>

                        <button onclick="state.modals.rules = true; render()" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-slate-400 transition-colors"><i data-lucide="book-open" class="w-5 h-5"></i></button>
                        <button onclick="state.modals.confirmEnd = true; render()" class="p-2 bg-red-900/20 hover:bg-red-900/40 text-red-400 rounded-lg border border-red-900/30 transition-colors"><i data-lucide="power" class="w-5 h-5"></i></button>
                    </div>
                </div>

                <!-- AVISO MODO ATAQUE -->
                ${state.attackMode ? `
                    <div class="mb-4 text-center animate-shake">
                        <span class="bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg border border-red-400 tracking-wider uppercase animate-pulse">
                            Modo Ataque: Selecione um Alvo
                        </span>
                    </div>
                ` : ''}

                <!-- GRID PLAYERS -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 pb-20 auto-rows-fr">
                    ${state.players.map(player => {
                        const isLeader = player.id === leaderId;
                        const isEliminated = player.status === 'ELIMINATED';
                        
                        let cardClass = "relative p-4 rounded-xl border-2 transition-all duration-300 flex flex-col justify-between ";
                        if (isEliminated) {
                            cardClass += "bg-slate-900/40 border-slate-800 opacity-50 ";
                        } else if (state.attackMode) {
                            cardClass += "bg-red-900/20 border-red-500/50 hover:bg-red-900/40 cursor-pointer hover:scale-[1.02] shadow-[0_0_15px_rgba(239,68,68,0.2)] animate-pulse-red ";
                        } else {
                            cardClass += "bg-slate-900 border-slate-700 ";
                            if (isLeader) cardClass += "border-yellow-500/50 shadow-[0_0_15px_rgba(234,179,8,0.15)] z-10 ";
                        }

                        return `
                        <div class="${cardClass}" onclick="handlePlayerClick(${player.id})">
                            ${isLeader && !isEliminated && !state.attackMode ? `<div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-yellow-500 text-slate-900 px-2 py-0.5 rounded-md text-[10px] font-bold flex items-center gap-1 shadow-lg uppercase tracking-wider"><i data-lucide="crown" class="w-3 h-3"></i> Líder</div>` : ''}
                            ${state.attackMode && !isEliminated ? `<div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-red-600 text-white px-2 py-0.5 rounded-md text-[10px] font-bold flex items-center gap-1 shadow-lg uppercase tracking-wider"><i data-lucide="crosshair" class="w-3 h-3"></i> ALVO</div>` : ''}
                            
                            ${isEliminated ? `<div class="absolute inset-0 flex items-center justify-center z-20 pointer-events-none"><div class="bg-red-900/90 text-red-100 px-3 py-1 rounded border border-red-500/50 rotate-[-10deg] shadow-xl text-sm font-black tracking-widest uppercase">Eliminado</div></div>` : ''}

                            <div class="flex justify-between items-start mb-2 pointer-events-none">
                                <div class="min-w-0">
                                    <h2 class="text-sm font-bold truncate text-slate-200">${player.name}</h2>
                                    <div class="flex items-center gap-1.5 mt-1">
                                        <div class="w-2 h-2 rounded-full ${player.status === 'ACTIVE' ? 'animate-pulse' : ''}" style="background-color: ${player.color.hex}; box-shadow: ${player.status === 'ACTIVE' ? `0 0 5px ${player.color.hex}` : 'none'}"></div>
                                        <span class="text-[10px] uppercase font-bold text-slate-500">${isEliminated ? 'Offline' : 'Online'}</span>
                                    </div>
                                </div>
                                <div class="text-3xl font-black font-mono tracking-tighter leading-none ${isEliminated ? 'text-red-900' : 'text-white'}">${player.score}</div>
                            </div>

                            ${!state.attackMode ? `
                                <div class="flex gap-2 mt-2 ${isEliminated ? 'pointer-events-none opacity-20 filter blur-[1px]' : ''}">
                                    <button class="flex-1 bg-slate-800 hover:bg-red-900/20 active:bg-red-900/30 border border-slate-700 hover:border-red-800 text-red-500 rounded-lg py-3 flex items-center justify-center transition-all select-none touch-manipulation active:scale-95 group"
                                        onmousedown="handleButtonDown(event, ${player.id}, 'remove')" onmouseup="handleButtonUp(${player.id}, 'remove')" onmouseleave="handleButtonUp(${player.id}, 'remove')" ontouchstart="handleButtonDown(event, ${player.id}, 'remove')" ontouchend="event.preventDefault(); handleButtonUp(${player.id}, 'remove')" oncontextmenu="event.preventDefault()">
                                        <i data-lucide="minus" class="w-5 h-5 group-active:scale-90 transition-transform"></i>
                                    </button>
                                    <button class="flex-1 bg-slate-800 hover:bg-green-900/20 active:bg-green-900/30 border border-slate-700 hover:border-green-800 text-green-500 rounded-lg py-3 flex items-center justify-center transition-all select-none touch-manipulation active:scale-95 group"
                                        onmousedown="handleButtonDown(event, ${player.id}, 'add')" onmouseup="handleButtonUp(${player.id}, 'add')" onmouseleave="handleButtonUp(${player.id}, 'add')" ontouchstart="handleButtonDown(event, ${player.id}, 'add')" ontouchend="event.preventDefault(); handleButtonUp(${player.id}, 'add')" oncontextmenu="event.preventDefault()">
                                        <i data-lucide="plus" class="w-5 h-5 group-active:scale-90 transition-transform"></i>
                                    </button>
                                </div>
                            ` : `
                                <div class="mt-2 py-3 bg-red-500/10 border border-red-500/30 rounded-lg flex items-center justify-center text-red-400 text-xs font-bold uppercase tracking-widest pointer-events-none">
                                    <i data-lucide="target" class="w-4 h-4 mr-2"></i> Selecionar
                                </div>
                            `}
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        }

        // 3. FINISHED SCREEN
        function renderFinished() {
            const sortedPlayers = [...state.players].sort((a, b) => {
                if (a.status === 'WINNER' && b.status === 'WINNER') return b.score - a.score;
                if (a.status === 'WINNER') return -1;
                if (b.status === 'WINNER') return 1;
                return b.survivalTime - a.survivalTime;
            });
            const winner = sortedPlayers[0];
            return `
            <div class="min-h-screen p-6 flex flex-col items-center justify-center font-sans animate-fade-in">
                <div class="max-w-xl w-full">
                    <div class="text-center mb-10">
                        <div class="inline-block p-4 rounded-full bg-yellow-500/10 mb-4 animate-bounce border border-yellow-500/20"><i data-lucide="trophy" class="w-12 h-12 text-yellow-500"></i></div>
                        <h1 class="text-3xl font-black mb-2 tracking-tight">Missão Cumprida</h1>
                        <p class="text-slate-500 flex items-center justify-center gap-2 font-mono text-sm"><i data-lucide="clock" class="w-4 h-4"></i> DURAÇÃO: <span class="text-green-400">${formatTime(state.gameDuration)}</span></p>
                    </div>
                    ${winner && winner.status === 'WINNER' ? `
                        <div class="bg-gradient-to-b from-slate-800 to-slate-900 border border-slate-700 p-6 rounded-2xl mb-6 flex items-center justify-between shadow-2xl relative overflow-hidden group">
                            <div class="absolute inset-0 bg-yellow-500/5 mix-blend-overlay group-hover:bg-yellow-500/10 transition-colors"></div>
                            <div class="flex items-center gap-4 relative z-10">
                                <div class="bg-yellow-500 w-12 h-12 rounded-lg flex items-center justify-center text-slate-900 font-black text-xl shadow-lg transform rotate-3 group-hover:rotate-0 transition-transform">1º</div>
                                <div><p class="text-yellow-500 font-bold uppercase text-[10px] tracking-widest mb-0.5">Sobrevivente</p><h2 class="text-2xl font-bold text-white">${winner.name}</h2></div>
                            </div>
                            <div class="text-right relative z-10"><p class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Integridade</p><p class="text-3xl font-black text-yellow-400 font-mono">${winner.score}</p></div>
                        </div>
                    ` : ''}
                    <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
                        <div class="px-5 py-3 bg-slate-800/50 border-b border-slate-800 flex justify-between items-center"><h3 class="font-bold text-slate-400 text-xs uppercase tracking-wider">Log de Combate</h3></div>
                        ${sortedPlayers.map((player, index) => {
                            if (index === 0 && player.status === 'WINNER') return '';
                            return `<div class="px-5 py-3 flex items-center justify-between border-b border-slate-800 last:border-0 hover:bg-slate-800/30 transition-colors">
                                <div class="flex items-center gap-3"><div class="w-6 h-6 rounded bg-slate-800 flex items-center justify-center font-bold text-slate-500 text-xs font-mono">#${index + 1}</div><div><div class="flex items-center gap-2"><span class="font-bold text-sm text-slate-300">${player.name}</span><div class="w-1.5 h-1.5 rounded-full" style="background-color: ${player.color.hex}"></div></div><div class="text-[10px] text-slate-500 font-mono">${player.status === 'WINNER' ? 'ONLINE' : `FALHA DO SISTEMA: ${formatTime(player.survivalTime)}`}</div></div></div>
                                <div class="font-mono font-bold text-lg ${player.status === 'ELIMINATED' ? 'text-red-500' : 'text-green-500'}">${player.score}</div>
                            </div>`;
                        }).join('')}
                    </div>
                    <button onclick="resetGame()" class="mt-8 w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-4 rounded-xl transition-all flex items-center justify-center gap-2 border border-slate-700"><i data-lucide="rotate-ccw" class="w-5 h-5"></i> REINICIAR SISTEMA</button>
                </div>
            </div>`;
        }

        // 4. ATTACK MODAL (INPUT)
        function renderAttackModal() {
            const player = state.players.find(p => p.id === state.modals.attack.targetId);
            if(!player) return '';

            return `
            <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-fade-in">
                <div class="bg-slate-900 w-full max-w-sm rounded-2xl border border-red-500/50 shadow-[0_0_30px_rgba(239,68,68,0.2)] animate-zoom-in overflow-hidden">
                    
                    <div class="bg-red-900/20 p-4 border-b border-red-900/30 flex items-center gap-3">
                        <div class="p-2 bg-red-500/20 rounded-lg"><i data-lucide="crosshair" class="w-6 h-6 text-red-500"></i></div>
                        <div>
                            <h3 class="text-white font-bold">Executar Malware</h3>
                            <p class="text-xs text-red-400">Alvo: <span class="font-mono font-bold text-white">${player.name}</span></p>
                        </div>
                    </div>

                    <div class="p-6 space-y-6">
                        <!-- Input Dano -->
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Dano Base do Ataque</label>
                            <div class="relative">
                                <input id="attack-input" type="number" value="${state.modals.attack.baseDamage}" 
                                    oninput="state.modals.attack.baseDamage = this.value"
                                    class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-4 text-2xl font-mono font-bold text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition-all placeholder-slate-700" />
                                <div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-600 text-sm font-bold">HP</div>
                            </div>
                            <!-- Botões Rápidos -->
                            <div class="grid grid-cols-5 gap-2 mt-3">
                                ${[5, 10, 15, 20, 25].map(val => `
                                    <button onclick="state.modals.attack.baseDamage = ${val}; render()" 
                                        class="h-9 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-red-500/50 text-slate-300 hover:text-white rounded-lg font-mono text-sm font-bold transition-all shadow-sm active:scale-95 ${state.modals.attack.baseDamage == val ? 'border-red-500 bg-red-900/20 text-white shadow-[0_0_10px_rgba(239,68,68,0.2)]' : ''}">
                                        ${val}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Toggle Defesa (Texto Alterado) -->
                        <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 flex items-center justify-between cursor-pointer hover:bg-slate-800 transition-colors"
                             onclick="state.modals.attack.hasDefense = !state.modals.attack.hasDefense; render()">
                            <div class="pr-2">
                                <div class="font-bold text-sm text-slate-200">Possui defesa da mesma categoria do ataque?</div>
                            </div>
                            <div class="w-12 h-6 rounded-full p-1 shrink-0 transition-colors duration-300 ${state.modals.attack.hasDefense ? 'bg-green-500' : 'bg-slate-600'}">
                                <div class="w-4 h-4 bg-white rounded-full shadow-md transform transition-transform duration-300 ${state.modals.attack.hasDefense ? 'translate-x-6' : 'translate-x-0'}"></div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-950/50 flex gap-3">
                        <button onclick="state.modals.attack.visible = false; render()" class="flex-1 py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold rounded-xl transition-colors">Cancelar</button>
                        <button onclick="executeAttack()" class="flex-[2] py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl shadow-lg shadow-red-900/30 flex items-center justify-center gap-2 transition-transform active:scale-95">
                            <i data-lucide="zap" class="w-5 h-5 fill-current"></i> EXECUTAR
                        </button>
                    </div>
                </div>
            </div>`;
        }

        // 5. RESULT MODAL (NOVO GRANDE)
        function renderResultModal() {
            const { message, type, base, actual } = state.modals.attackResult;
            
            let colorClass = 'text-slate-200';
            let icon = 'info';
            
            if (type === 'danger') { colorClass = 'text-red-500'; icon = 'skull'; }
            else if (type === 'warning') { colorClass = 'text-orange-500'; icon = 'alert-triangle'; }
            else if (type === 'success') { colorClass = 'text-green-500'; icon = 'shield-check'; }

            return `
            <div class="fixed inset-0 z-[80] flex items-center justify-center bg-black/95 backdrop-blur-xl p-4 animate-fade-in">
                <div class="w-full max-w-md flex flex-col items-center justify-center text-center animate-zoom-in">
                    
                    <div class="mb-6 p-6 rounded-full bg-slate-900 border-4 border-slate-800 shadow-[0_0_50px_rgba(0,0,0,0.5)]">
                        <i data-lucide="${icon}" class="w-20 h-20 ${colorClass}"></i>
                    </div>

                    <h2 class="text-2xl font-black text-white mb-4 leading-tight">${message}</h2>

                    <div class="flex items-center gap-6 mb-10 bg-slate-900/50 px-8 py-4 rounded-2xl border border-slate-800">
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Dano Base</span>
                            <span class="text-2xl font-mono font-bold text-slate-400 line-through decoration-red-500/50">${base}</span>
                        </div>
                        <i data-lucide="arrow-right" class="w-6 h-6 text-slate-600"></i>
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Dano Real</span>
                            <span class="text-4xl font-mono font-black ${type === 'danger' ? 'text-red-500' : 'text-white'}">${actual}</span>
                        </div>
                    </div>

                    <button onclick="closeResultModal()" class="relative overflow-hidden w-64 bg-slate-800 hover:bg-slate-700 text-white font-bold py-4 rounded-xl transition-all border border-slate-600 group">
                        <span class="relative z-10">OK (Fechar)</span>
                        <div class="absolute bottom-0 left-0 h-1 bg-green-500 animate-progress"></div>
                    </button>

                </div>
            </div>
            `;
        }

        // 6. RULES MODAL
        function renderRulesModal() {
            const tab = state.activeRulesTab;
            let content = '';
            
            // ... (Conteúdo das regras mantido igual, apenas renderizado se chamado) ...
            if (tab === 'overview') {
                content = `
                <div class="space-y-4 animate-slide-in">
                    <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                        <h3 class="text-white font-bold mb-2 flex items-center gap-2"><i data-lucide="swords" class="w-5 h-5 text-red-400"></i> Objetivo</h3>
                        <p>Ser o último sobrevivente com <strong>Integridade acima de 0</strong>. Use ataques cibernéticos para drenar oponentes e defesas para proteger seus sistemas.</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-700/30 p-3 rounded-lg">
                            <h4 class="font-bold text-white mb-1">Início</h4>
                            <ul class="text-sm list-disc list-inside space-y-1 text-slate-400">
                                <li>Integridade: 100</li>
                                <li>3 Cartas de Ataque</li>
                                <li>3 Cartas de Defesa</li>
                                <li>2 Cartas de Recurso</li>
                            </ul>
                        </div>
                        <div class="bg-slate-700/30 p-3 rounded-lg">
                            <h4 class="font-bold text-white mb-1">Combate</h4>
                            <p class="text-sm text-slate-400">Defesas anulam ataques da mesma categoria.</p>
                            <p class="text-xs text-yellow-500 mt-2 font-bold">Regra de Ouro: O texto da carta sempre tem prioridade sobre as regras gerais.</p>
                        </div>
                    </div>
                </div>`;
            } else if (tab === 'turn') {
                content = `
                <div class="space-y-4 animate-slide-in">
                    <ol class="relative border-l border-slate-600 ml-3 space-y-6">
                        <li class="ml-6">
                            <span class="absolute flex items-center justify-center w-8 h-8 bg-green-900 rounded-full -left-4 ring-4 ring-slate-800 text-green-400 font-bold text-sm">1</span>
                            <h3 class="font-bold text-white mb-1">Fase de Compra</h3>
                            <ul class="text-sm text-slate-400 list-disc list-inside">
                                <li>Compre <strong>2 Cartas de Recurso</strong>.</li>
                                <li>Complete a mão até ter <strong>3 Ataques</strong> e <strong>3 Defesas</strong>.</li>
                            </ul>
                        </li>
                        <li class="ml-6">
                            <span class="absolute flex items-center justify-center w-8 h-8 bg-blue-900 rounded-full -left-4 ring-4 ring-slate-800 text-blue-400 font-bold text-sm">2</span>
                            <h3 class="font-bold text-white mb-1">Ajuste (Opcional)</h3>
                            <p class="text-sm">Troque 2 cartas da mão por 1 Recurso extra.</p>
                        </li>
                        <li class="ml-6">
                            <span class="absolute flex items-center justify-center w-8 h-8 bg-red-900 rounded-full -left-4 ring-4 ring-slate-800 text-red-400 font-bold text-sm">3</span>
                            <h3 class="font-bold text-white mb-1">Fase de Ação</h3>
                            <div class="bg-slate-900/50 p-3 rounded mt-2 border border-slate-700 text-sm space-y-2">
                                <p><strong class="text-red-400">Atacar:</strong> Escolha <strong>qualquer alvo</strong>, pague o custo e cause dano. (Cartas com efeito persistente devem ficar viradas para cima na mesa).</p>
                                <p><strong class="text-green-400">Defender:</strong> Instale defesas pagando o custo.</p>
                            </div>
                            <div class="mt-2 p-2 bg-slate-700/50 rounded border-l-2 border-yellow-500">
                                <p class="text-xs text-slate-300"><strong>Fim do Turno:</strong> O turno acaba quando seus recursos esgotam ou você decide passar a vez.</p>
                            </div>
                        </li>
                    </ol>
                </div>`;
            } else if (tab === 'resources') {
                content = `
                <div class="space-y-4 animate-slide-in">
                    <div class="bg-indigo-900/20 border border-indigo-500/30 p-4 rounded-lg">
                        <h3 class="font-bold text-white text-md mb-2 flex items-center gap-2"><i data-lucide="coins" class="w-5 h-5 text-indigo-400"></i> Especialização</h3>
                        <p class="text-sm text-slate-300">Recursos especializados valem o dobro para sua categoria específica.</p>
                        <div class="mt-3 flex flex-wrap gap-2">
                            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300 border border-slate-600">Malware</span>
                            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300 border border-slate-600">Vulnerabilidade</span>
                            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300 border border-slate-600">Engenharia Social</span>
                            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300 border border-slate-600">Web</span>
                            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300 border border-slate-600">Rede</span>
                        </div>
                    </div>

                    <div class="bg-slate-900 border border-slate-700 p-4 rounded-lg flex flex-col gap-3 shadow-lg">
                        <div class="flex items-center justify-between border-b border-slate-700 pb-2">
                            <span class="text-xs font-bold text-slate-500 uppercase">Exemplo: Recurso de Rede</span>
                            <div class="px-2 py-0.5 bg-blue-500/20 text-blue-300 text-[10px] rounded border border-blue-500/30 font-bold">Verba: Infra de Rede</div>
                        </div>
                        <div class="flex gap-4">
                            <div class="flex-1 bg-green-900/20 border border-green-500/30 p-3 rounded flex flex-col items-center justify-center text-center">
                                <div class="text-2xl font-black text-green-400 mb-1">2</div>
                                <p class="text-[10px] text-green-200 leading-tight">Para cartas de<br>REDE</p>
                            </div>
                            <div class="flex items-center text-slate-500 font-bold text-lg">vs</div>
                            <div class="flex-1 bg-slate-800 border border-slate-600 p-3 rounded flex flex-col items-center justify-center text-center opacity-70">
                                <div class="text-2xl font-black text-white mb-1">1</div>
                                <p class="text-[10px] text-slate-300 leading-tight">Outras<br>Categorias</p>
                            </div>
                        </div>
                    </div>
                </div>`;
            } else if (tab === 'events') {
                const events = [
                    "LGPD/GDPR: Pague 1 Recurso ou perca 10 HP.",
                    "Surto de Malware: Sem patch? -15 HP.",
                    "Corte de Orçamento: Descarte 1 Recurso.",
                    "Auditoria: >2 Defesas ganha recurso, senão descarta ação.",
                    "Phishing Massivo: Ataques Sociais +5 dano.",
                    "Sem Backup: Café no servidor causa -10 HP.",
                    "Vazamento de Credenciais: Sem MFA -10 HP.",
                    "Ataque de Força Bruta: Sem Gerenciador de Senhas -10 HP."
                ];
                content = `
                <div class="space-y-4 animate-slide-in">
                    <div class="bg-yellow-500/10 border border-yellow-500/30 p-4 rounded-lg flex gap-3 items-start">
                        <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-500 shrink-0 mt-1"></i>
                        <div><h3 class="font-bold text-white text-sm">Rodada de Eventos</h3><p class="text-sm text-slate-400 mt-1">No início de cada nova rodada (após todos jogarem), revele 1 carta de Evento. Efeito imediato para TODOS.</p></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs">
                        ${events.map(evt => `<div class="bg-slate-700/40 p-2 rounded border-l-2 border-purple-500 text-slate-300">${evt}</div>`).join('')}
                    </div>
                </div>`;
            }

            return `
            <div class="fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                <div class="bg-slate-800 w-full max-w-2xl rounded-2xl border border-slate-600 shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                    <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                        <div class="flex items-center gap-2 text-green-400"><i data-lucide="book-open" class="w-6 h-6"></i><h2 class="text-xl font-bold font-mono">Manual: Pwned!</h2></div>
                        <button onclick="state.modals.rules = false; render()" class="p-2 hover:bg-slate-700 rounded-full transition-colors text-slate-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                    <div class="flex border-b border-slate-700 bg-slate-800 overflow-x-auto">
                        <button onclick="state.activeRulesTab = 'overview'; render()" class="whitespace-nowrap flex-1 py-3 px-4 flex items-center justify-center gap-2 text-sm font-bold transition-colors border-b-2 ${tab === 'overview' ? 'border-green-500 text-green-400 bg-slate-700/30' : 'border-transparent text-slate-400 hover:text-white hover:bg-slate-700/50'}"><i data-lucide="shield" class="w-4 h-4"></i> Geral</button>
                        <button onclick="state.activeRulesTab = 'turn'; render()" class="whitespace-nowrap flex-1 py-3 px-4 flex items-center justify-center gap-2 text-sm font-bold transition-colors border-b-2 ${tab === 'turn' ? 'border-green-500 text-green-400 bg-slate-700/30' : 'border-transparent text-slate-400 hover:text-white hover:bg-slate-700/50'}"><i data-lucide="clock" class="w-4 h-4"></i> Turno</button>
                        <button onclick="state.activeRulesTab = 'resources'; render()" class="whitespace-nowrap flex-1 py-3 px-4 flex items-center justify-center gap-2 text-sm font-bold transition-colors border-b-2 ${tab === 'resources' ? 'border-green-500 text-green-400 bg-slate-700/30' : 'border-transparent text-slate-400 hover:text-white hover:bg-slate-700/50'}"><i data-lucide="coins" class="w-4 h-4"></i> Recursos</button>
                        <button onclick="state.activeRulesTab = 'events'; render()" class="whitespace-nowrap flex-1 py-3 px-4 flex items-center justify-center gap-2 text-sm font-bold transition-colors border-b-2 ${tab === 'events' ? 'border-green-500 text-green-400 bg-slate-700/30' : 'border-transparent text-slate-400 hover:text-white hover:bg-slate-700/50'}"><i data-lucide="zap" class="w-4 h-4"></i> Eventos</button>
                    </div>
                    <div class="p-6 overflow-y-auto custom-scrollbar bg-slate-800 text-slate-300 space-y-4">${content}</div>
                </div>
            </div>`;
        }

        // CONFIRM MODAL
        function renderConfirmModal() {
            return `<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in"><div class="bg-slate-800 p-6 rounded-2xl border border-slate-600 shadow-2xl max-w-sm w-full transform scale-100 animate-zoom-in"><div class="flex justify-center mb-4"><div class="bg-yellow-500/20 p-3 rounded-full"><i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-500"></i></div></div><h3 class="text-xl font-bold text-white text-center mb-2">Abortar Missão?</h3><p class="text-slate-400 text-center mb-6">Tem certeza que deseja encerrar a partida agora?</p><div class="flex gap-3"><button onclick="state.modals.confirmEnd = false; render()" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-semibold transition-colors">Cancelar</button><button onclick="finishGame()" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white rounded-xl font-semibold transition-colors shadow-lg shadow-red-900/20">Confirmar</button></div></div></div>`;
        }

        // MENU LONG PRESS
        function renderLongPressMenu() {
            const { type } = state.modals.longPress;
            return `<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in" onclick="state.modals.longPress.visible = false; render()"><div class="bg-slate-800 rounded-xl p-4 shadow-2xl border border-slate-600 transform scale-100 animate-zoom-in w-64" onclick="event.stopPropagation()"><h3 class="text-center text-xs font-bold uppercase tracking-wider text-slate-400 mb-3">${type === 'add' ? 'Adicionar Integridade' : 'Dano Crítico'}</h3><div class="grid grid-cols-5 gap-2">${VALUES_OPTIONS.map(val => `<button onclick="handleMenuSelect(${val})" class="h-10 rounded-lg font-bold text-sm shadow-lg flex items-center justify-center transition-transform hover:scale-110 active:scale-95 ${type === 'add' ? 'bg-green-600 hover:bg-green-500 text-white' : 'bg-red-600 hover:bg-red-500 text-white'}">${val}</button>`).join('')}</div></div></div>`;
        }

        init();
    </script>
</body>
</html>



